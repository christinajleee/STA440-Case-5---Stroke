---
title: "MICE Freq and EDA"
format: pdf
editor: visual
---

```{r}
library(tidyverse)
library(ggplot2)
library(naniar)
library(corrplot)
library(gridExtra)
library(purrr)
library(broom)
library(car)      
library(pROC) 
library(scales)
library(patchwork)
library(naniar)
#install.packages("kableExtra")
library(kableExtra)
library(mice)
#install.packages("ResourceSelection")
library(ResourceSelection)
load("strokeStudy.RData")
df <- x

df <- df %>%
  mutate(
    Race2 = if_else(
      tolower(as.character(Race2)) == "missing",
      NA_character_,
      as.character(Race2)
    ),
    siteID = as.factor(as.character(siteID))
  )

#df %>%
#  count(Race2, sort = TRUE)

#unique(df$siteID)
```

```{r}
#added a phase variable and a treatment variable
df <- df %>%
  mutate(
    operation_type = case_when(
      hadThrombectomy & !hadTPA ~ "Thrombectomy only",
      !hadThrombectomy & hadTPA ~ "TPA only",
      hadThrombectomy & hadTPA  ~ "Both",
      !hadThrombectomy & !hadTPA ~ "None",
      TRUE ~ NA_character_
    ),
    operation_type = factor(operation_type,
                            levels = c("None", "TPA only", "Thrombectomy only", "Both")),
    Time2 = as.character(Time2),
    phase = case_when(
      Time2 %in% c("Y1Q1", "Y1Q2") ~ "control",
      Time2 %in% c("Y2Q3", "Y2Q4") ~ "treatment",
      TRUE ~ "implementation"
    ),
    phase = factor(phase, levels = c("control", "implementation", "treatment")),
    complication_type = case_when(
      tpaComplic & !thrComplic ~ "TPA complication",
      !tpaComplic & thrComplic ~ "Thrombectomy complication",
      tpaComplic & thrComplic  ~ "Both complications",
      !tpaComplic & !thrComplic ~ "No complication",
      TRUE ~ NA_character_
    ),
    complication_type = factor(
      complication_type,
      levels = c("No complication",
                 "TPA complication",
                 "Thrombectomy complication",
                 "Both complications")
    )
  )

df <- df %>%
  filter(!is.na(homeOrRehab))
#df

# df_with_complications <- df %>%
#   filter(tpaComplic | thrComplic)
# 
# df_with_complications
# 
# df %>%
#   count(complication_type) %>%
#   mutate(
#     percent = round(100 * n / sum(n), 1)
#   )


```

```{r}
ggplot(df, aes(x = operation_type, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  facet_wrap(~ phase) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Operation Type",
    y = "Percent of Patients",
    fill = "Home/Rehab",
    title = "Distribution of Home/Rehab Outcomes by Operation Type and Phase"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 25, hjust = 1)
  )

ggplot(df, aes(x = operation_type, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  facet_wrap(~ complication_type) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Operation Type",
    y = "Percent of Patients",
    fill = "Home/Rehab",
    title = "Home/Rehab Outcome by Operation Type, by Complication"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 25, hjust = 1)
  )


```

```{r}


ggplot(df, aes(x = Gender, fill = complication_type)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Gender",
    y = "Percent of Patients",
    fill = "Complication Type",
    title = "Proportion of Complication Types by Gender"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12),
    legend.position = "right"
  )
df %>%
  count(Gender, complication_type) %>%          # counts for all categories
  group_by(Gender) %>%
  mutate(
    percent_within_gender = round(100 * n / sum(n), 1)
  ) %>%
  arrange(Gender, complication_type)

```
```{r}

df_comp_race <- df %>%
  filter(!is.na(Race2))   # optional: drop NA race

ggplot(df_comp_race, aes(x = Race2, fill = complication_type)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Race",
    y = "Percent of Patients",
    fill = "Complication Type",
    title = "Proportion of Complication Types by Race"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

df %>%
  filter(!is.na(Race2)) %>%
  count(Race2, complication_type) %>%
  group_by(Race2) %>%
  mutate(
    percent_within_race = round(100 * n / sum(n), 1)
  ) %>%
  arrange(Race2, complication_type)

```


```{r}
df %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "n_missing") %>%
  mutate(
    percent_missing = round(100 * n_missing / nrow(df), 2)
  ) %>%
  filter(n_missing > 0) %>%       
  arrange(desc(n_missing))



missing_summary <- df %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "n_missing") %>%
  mutate(percent_missing = round(100 * n_missing / nrow(df), 2)) %>%
  filter(n_missing > 0) %>%
  arrange(desc(n_missing))

missing_summary

missing_vars <- missing_summary$variable

miss_df <- df %>%
  mutate(across(all_of(missing_vars), ~ as.integer(is.na(.)), .names = "miss_{.col}"))

miss_cor <- miss_df %>%
  select(starts_with("miss_")) %>%
  cor(use = "pairwise.complete.obs")

miss_cor


library(knitr)

kable(
  round(miss_cor, 3),
  caption = "Correlation of Missingness Indicators",
  align = "c"
)
```

```{r}
vis_miss(df)
df %>% 
  summarise(across(everything(), ~ mean(is.na(.))*100)) %>% 
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "pct_missing") %>% 
  arrange(desc(pct_missing))
gg_miss_upset(df)

miss_by_site <- df %>%
  group_by(siteID) %>%
  summarise(across(everything(), 
                   ~ mean(is.na(.)), 
                   .names = "missing_{col}"))

miss_by_site

miss_by_site %>%
  pivot_longer(-siteID) %>%
  ggplot(aes(x = name, y = siteID, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Missingness by Site",
       x = "Variable", y = "SiteID", fill = "% Missing") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}

imp_df <- df %>%
  mutate(
    Age = as.numeric(Age),
    PreHospNotify = as.factor(PreHospNotify),
    EMSvsCar = as.factor(EMSvsCar),
    Race2 = as.factor(Race2),
    phase = as.factor(phase),
    operation_type = as.factor(operation_type),
    complication_type = as.factor(complication_type)
  )




# Initialize with default methods
meth <- make.method(imp_df)

# Specify the imputation method for each variable of interest
meth["Age"]            <- "norm"      # linear regression
meth["PreHospNotify"]  <- "logreg"    # logistic regression for binary
meth["EMSvsCar"]       <- "logreg"    # logistic regression for binary
meth["Race2"]          <- "polyreg"   # multinomial logistic regression
meth["phase"] <- ""
meth["operation_type"] <- ""
meth["complication_type"] <- ""

# (Everything else stays "" meaning “passive”/leave as is)
meth
pred <- make.predictorMatrix(imp_df)

# Remove self-prediction
pred[c("Age", "PreHospNotify", "EMSvsCar", "Race2"),
     c("Age", "PreHospNotify", "EMSvsCar", "Race2")] <- 0
set.seed(123)

imp <- mice(imp_df, method = meth, predictorMatrix = pred, m = 20, maxit = 20)
completed_df <- complete(imp, action = "long")
# Or: complete(imp, 1) for the first filled-in dataset

```


```{r}
plot(imp) 

df_mice <- complete(imp, 1)
#df_mice

```

```{r}
model1_fit <- with(
  imp,
  glm(
    homeOrRehab ~ Age + Gender + Race2 + EMSvsCar + PreHospNotify +
      hadThrombectomy + hadTPA + tpaComplic + thrComplic +
      siteID + Time2,
    family = binomial()
  )
)

model1_pooled <- pool(model1_fit)
summary(model1_pooled)

model2_fit <- with(
  imp,
  glm(
    homeOrRehab ~ Age + Gender + Race2 + EMSvsCar + PreHospNotify +
      siteID + phase + operation_type + complication_type,
    family = binomial()
  )
)

model2_pooled <- pool(model2_fit)
summary(model2_pooled)



# model1_table <- tidy(model1_pooled, conf.int = TRUE, exponentiate = TRUE) %>%
#   mutate(across(where(is.numeric), ~ round(., 3))) %>%
#   select(term, estimate, conf.low, conf.high, p.value) %>%
#   rename(
#     OR = estimate,
#     CI_low = conf.low,
#     CI_high = conf.high,
#     p = p.value
#   ) %>%
#   kbl(
#     caption = "Pooled Logistic Regression Results — Model 1 (Original Predictors)",
#     align = "c"
#   ) %>%
#   kable_classic(full_width = FALSE)
# 
# model1_table
# 
# model2_table <- tidy(model2_pooled, conf.int = TRUE, exponentiate = TRUE) %>%
#   mutate(across(where(is.numeric), ~ round(., 3))) %>%
#   select(term, estimate, conf.low, conf.high, p.value) %>%
#   rename(
#     OR = estimate,
#     CI_low = conf.low,
#     CI_high = conf.high,
#     p = p.value
#   ) %>%
#   kbl(
#     caption = "Pooled Logistic Regression Results — Model 2 (Phase + Combined Variables)",
#     align = "c"
#   ) %>%
#   kable_classic(full_width = FALSE)
# 
# model2_table

```


```{r}
AIC_m1 <- mean(sapply(model1_fit$analyses, AIC))
AIC_m2 <- mean(sapply(model2_fit$analyses, AIC))

AIC_m1
AIC_m2


auc1 <- sapply(1:imp$m, function(i) {
  data_i <- complete(imp, i)
  m <- model1_fit$analyses[[i]]
  p <- predict(m, newdata = data_i, type = "response")
  roc(data_i$homeOrRehab, p)$auc
})

auc2 <- sapply(1:imp$m, function(i) {
  data_i <- complete(imp, i)
  m <- model2_fit$analyses[[i]]
  p <- predict(m, newdata = data_i, type = "response")
  roc(data_i$homeOrRehab, p)$auc
})

mean(auc1)
mean(auc2)

```


```{r}

# First imputed model
m1 <- model1_fit$analyses[[1]]
data1 <- complete(imp, 1)

data1$.fitted <- predict(m1, type = "link")
data1$.resid <- residuals(m1, type = "deviance")
data1$.cook <- cooks.distance(m1)
data1$.lev <- hatvalues(m1)

# Residuals vs fitted
ggplot(data1, aes(.fitted, .resid)) +
  geom_point(alpha = 0.4) +
  geom_hline(yintercept = 0, color = "red") +
  labs(title = "Deviance Residuals vs Fitted (Model 1)")

# Cook's distance
ggplot(data1, aes(seq_along(.cook), .cook)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 4/ nrow(data1), color = "red") +
  labs(title = "Cook's Distance (Model 1)")




hl_tests <- sapply(1:imp$m, function(i) {
  data_i <- complete(imp, i)
  m <- model1_fit$analyses[[i]]
  p <- predict(m, newdata = data_i, type = "response")
  hoslem.test(data_i$homeOrRehab, p, g = 10)$p.value
})

hl_tests
mean(hl_tests)



data_i <- complete(imp, 1)
m <- model1_fit$analyses[[1]]
p <- predict(m, newdata = data_i, type = "response")

roc1 <- roc(data_i$homeOrRehab, p)
plot(roc1, main = "ROC Curve for Model 1")
auc(roc1)
coords(roc1, "best", ret=c("threshold", "sensitivity", "specificity"))
```



