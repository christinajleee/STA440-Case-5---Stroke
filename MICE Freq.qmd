---
title: "MICE Freq and EDA"
format: pdf
editor: visual
---

```{r}
library(tidyverse)
library(ggplot2)
library(naniar)
library(corrplot)
library(gridExtra)
library(purrr)
library(broom)
library(car)      
library(pROC) 
library(scales)
library(patchwork)
library(naniar)

library(mice)

load("strokeStudy.RData")
df <- x

df <- df %>%
  mutate(
    Race2 = if_else(
      tolower(as.character(Race2)) == "missing",
      NA_character_,
      as.character(Race2)
    ),
    siteID = as.factor(as.character(siteID))
  )

#df %>%
#  count(Race2, sort = TRUE)

#unique(df$siteID)
```

```{r}
#added a phase variable and a treatment variable
df <- df %>%
  mutate(
    operation_type = case_when(
      hadThrombectomy & !hadTPA ~ "Thrombectomy only",
      !hadThrombectomy & hadTPA ~ "TPA only",
      hadThrombectomy & hadTPA  ~ "Both",
      !hadThrombectomy & !hadTPA ~ "None",
      TRUE ~ NA_character_
    ),
    operation_type = factor(operation_type,
                            levels = c("None", "TPA only", "Thrombectomy only", "Both")),
    Time2 = as.character(Time2),
    phase = case_when(
      Time2 %in% c("Y1Q1", "Y1Q2") ~ "control",
      Time2 %in% c("Y2Q3", "Y2Q4") ~ "treatment",
      TRUE ~ "implementation"
    ),
    phase = factor(phase, levels = c("control", "implementation", "treatment")),
    complication_type = case_when(
      tpaComplic & !thrComplic ~ "TPA complication",
      !tpaComplic & thrComplic ~ "Thrombectomy complication",
      tpaComplic & thrComplic  ~ "Both complications",
      !tpaComplic & !thrComplic ~ "No complication",
      TRUE ~ NA_character_
    ),
    complication_type = factor(
      complication_type,
      levels = c("No complication",
                 "TPA complication",
                 "Thrombectomy complication",
                 "Both complications")
    )
  )

df <- df %>%
  filter(!is.na(homeOrRehab))
#df

# df_with_complications <- df %>%
#   filter(tpaComplic | thrComplic)
# 
# df_with_complications
# 
# df %>%
#   count(complication_type) %>%
#   mutate(
#     percent = round(100 * n / sum(n), 1)
#   )


```

```{r}
ggplot(df, aes(x = operation_type, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  facet_wrap(~ phase) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Operation Type",
    y = "Percent of Patients",
    fill = "Home/Rehab",
    title = "Distribution of Home/Rehab Outcomes by Operation Type and Phase"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 25, hjust = 1)
  )

ggplot(df, aes(x = operation_type, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  facet_wrap(~ complication_type) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Operation Type",
    y = "Percent of Patients",
    fill = "Home/Rehab",
    title = "Home/Rehab Outcome by Operation Type, by Complication"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 25, hjust = 1)
  )


```

```{r}


ggplot(df, aes(x = Gender, fill = complication_type)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Gender",
    y = "Percent of Patients",
    fill = "Complication Type",
    title = "Proportion of Complication Types by Gender"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12),
    legend.position = "right"
  )
df %>%
  count(Gender, complication_type) %>%          # counts for all categories
  group_by(Gender) %>%
  mutate(
    percent_within_gender = round(100 * n / sum(n), 1)
  ) %>%
  arrange(Gender, complication_type)

```
```{r}

df_comp_race <- df %>%
  filter(!is.na(Race2))   # optional: drop NA race

ggplot(df_comp_race, aes(x = Race2, fill = complication_type)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Race",
    y = "Percent of Patients",
    fill = "Complication Type",
    title = "Proportion of Complication Types by Race"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

df %>%
  filter(!is.na(Race2)) %>%
  count(Race2, complication_type) %>%
  group_by(Race2) %>%
  mutate(
    percent_within_race = round(100 * n / sum(n), 1)
  ) %>%
  arrange(Race2, complication_type)

```


```{r}
df %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "n_missing") %>%
  mutate(
    percent_missing = round(100 * n_missing / nrow(df), 2)
  ) %>%
  filter(n_missing > 0) %>%       
  arrange(desc(n_missing))



missing_summary <- df %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "n_missing") %>%
  mutate(percent_missing = round(100 * n_missing / nrow(df), 2)) %>%
  filter(n_missing > 0) %>%
  arrange(desc(n_missing))

missing_summary

missing_vars <- missing_summary$variable

miss_df <- df %>%
  mutate(across(all_of(missing_vars), ~ as.integer(is.na(.)), .names = "miss_{.col}"))

miss_cor <- miss_df %>%
  select(starts_with("miss_")) %>%
  cor(use = "pairwise.complete.obs")

miss_cor


library(knitr)

kable(
  round(miss_cor, 3),
  caption = "Correlation of Missingness Indicators",
  align = "c"
)
```


```{r}
imp_df <- df %>%
  mutate(
    Age = as.numeric(Age),
    PreHospNotify = as.factor(PreHospNotify),
    EMSvsCar = as.factor(EMSvsCar),
    Race2 = as.factor(Race2)
  )


# Initialize with default methods
meth <- make.method(imp_df)

# Specify the imputation method for each variable of interest
meth["Age"]            <- "norm"      # linear regression
meth["PreHospNotify"]  <- "logreg"    # logistic regression for binary
meth["EMSvsCar"]       <- "logreg"    # logistic regression for binary
meth["Race2"]          <- "polyreg"   # multinomial logistic regression

# (Everything else stays "" meaning “passive”/leave as is)
meth
pred <- make.predictorMatrix(imp_df)

# Remove self-prediction
pred[c("Age", "PreHospNotify", "EMSvsCar", "Race2"),
     c("Age", "PreHospNotify", "EMSvsCar", "Race2")] <- 0
set.seed(123)

imp <- mice(
  data = imp_df,
  m = 20,                # number of imputed datasets
  method = meth,
  predictorMatrix = pred,
  maxit = 20,           # cycles
  printFlag = TRUE
)
completed_df <- complete(imp, action = "long")
# Or: complete(imp, 1) for the first filled-in dataset

```


```{r}
plot(imp) 

```

